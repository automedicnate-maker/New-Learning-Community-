<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FreeAutoDiag</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #f3f4f6; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .disclaimer { background: #fff3cd; border: 1px solid #ffe69c; padding: 10px; border-radius: 8px; margin-bottom: 14px; }
    .tabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    .tab-button { padding: 10px 14px; border-radius: 10px 10px 0 0; border: 0; cursor: pointer; font-weight: 600; }
    .active { background: #2563eb; color: #fff; }
    .inactive { background: #d1d5db; }
    .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,.1); }
    input, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #d1d5db; margin-bottom: 10px; }
    button { border: 0; border-radius: 8px; padding: 10px 12px; cursor: pointer; font-weight: 600; }
    .primary { background: #2563eb; color: #fff; }
    .danger { background: #dc2626; color: #fff; }
    .ok { background: #16a34a; color: #fff; }
    .warn { background: #d97706; color: #fff; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 200px; }
    ul { padding-left: 18px; }
    pre { background: #111827; color: #f9fafb; padding: 10px; border-radius: 8px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üöó FreeAutoDiag</h1>
    <div class="disclaimer">Public sources only. Always verify with official service info.</div>

    <div class="tabs" id="tabs"></div>
    <section class="card" id="content"></section>
  </div>

<script>
const tabs = ['lookup','dashboard','obd','simulator'];
let state = {
  activeTab: 'lookup',
  vin: '',
  vehicle: null,
  obdSearch: '',
  obdResults: [],
  youtubeVideos: [],
  youtubeKey: localStorage.getItem('youtubeKey') || '',
  simulatorMode: 'guided',
  selectedCircuit: 'charging',
  fault: 'none',
  measurement: { point:'', value:'' },
  scopeData: 'Normal waveform',
};

const circuits = {
  charging: {name:'Battery & Charging System', diagram:'üü¢ Battery (+) ‚îÄ‚îÄ Alternator ‚îÄ‚îÄ Fuse ‚îÄ‚îÄ Loads\n‚ö´ Ground (‚îÄ)', probePoints:['Battery Positive','Alternator Output','Battery Negative'], normalReadings:{'Battery Positive':'12.6V','Alternator Output':'13.8-14.5V','Battery Negative':'0V'}},
  starting: {name:'Starting System', diagram:'Key ‚Üí Relay Coil ‚Üí Contacts ‚Üí Starter Motor ‚Üí Ground', probePoints:['Relay Control','Starter Positive','Battery at Crank'], normalReadings:{'Relay Control':'12V when cranking','Starter Positive':'10-12V','Battery at Crank':'‚â•9.6V'}},
  crank: {name:'Crankshaft Position Sensor', diagram:'5V Ref ‚îÄ‚îÄ Sensor ‚îÄ‚îÄ Signal Wire ‚îÄ‚îÄ ECU\nScope shows 0-5V pulses', probePoints:['Sensor Power','Signal Wire','Ground'], normalReadings:{'Sensor Power':'5V','Signal Wire':'Pulsing 0-5V','Ground':'0V'}}
};

function renderTabs(){
  tabsEl.innerHTML = tabs.map(t => `<button class="tab-button ${state.activeTab===t?'active':'inactive'}" onclick="setTab('${t}')">${t[0].toUpperCase()+t.slice(1)}</button>`).join('');
}
function setTab(tab){ state.activeTab = tab; render(); }

async function fetchVehicle(){
  if(!state.vin) return;
  const res = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValuesExtended/${state.vin}?format=json`);
  const data = await res.json();
  state.vehicle = data.Results?.[0] || null;
  state.activeTab = 'dashboard';
  render();
}

async function searchOBD(){
  const res = await fetch('/data/obd-codes.json');
  const all = await res.json();
  const q = state.obdSearch.toLowerCase();
  state.obdResults = all.filter(c => c.code.includes(state.obdSearch.toUpperCase()) || c.description.toLowerCase().includes(q)).slice(0,10);
  render();
}

async function searchYouTube(){
  if(!state.youtubeKey || !state.vehicle) return alert('Add YouTube API key first.');
  const q = `${state.vehicle.Make} ${state.vehicle.Model} ${state.vehicle.ModelYear} repair`;
  const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(q)}&maxResults=3&key=${state.youtubeKey}`;
  const data = await (await fetch(url)).json();
  state.youtubeVideos = data.items || [];
  render();
}

function saveApiKey(v){ state.youtubeKey=v; localStorage.setItem('youtubeKey', v); }

function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(`FreeAutoDiag Report - ${state.vehicle?.ModelYear||''} ${state.vehicle?.Make||''} ${state.vehicle?.Model||''}`, 14, 15);
  doc.text('Public sources only. Always verify with official service info.', 14, 24);
  doc.autoTable({ startY: 32, head:[['Code','Description']], body: state.obdResults.map(r => [r.code, r.description]) });
  doc.save('FreeAutoDiag-Report.pdf');
}

function injectFault(f){
  state.fault = f;
  state.scopeData = f==='none' ? 'Normal waveform' : f==='open-ground' ? 'No signal / flat line' : 'Low amplitude waveform';
  if(f!=='none') alert(`FAULT INJECTED: ${f}`);
  render();
}

function takeMeasurement(point){
  const current = circuits[state.selectedCircuit];
  let value = current.normalReadings[point] || '0V';
  if(state.fault!=='none' && point.includes('Battery')) value = state.fault==='low-voltage' ? '12.1V' : '0V';
  state.measurement = {point, value};
  render();
}

function render(){
  renderTabs();
  if(state.activeTab==='lookup'){
    content.innerHTML = `<h3>Vehicle Lookup</h3>
      <input placeholder="Enter VIN" value="${state.vin}" oninput="state.vin=this.value">
      <button class="primary" onclick="fetchVehicle()">Decode & Load Vehicle</button>`;
  }
  if(state.activeTab==='dashboard'){
    content.innerHTML = state.vehicle ? `<h3>${state.vehicle.ModelYear} ${state.vehicle.Make} ${state.vehicle.Model}</h3>
      <p>Engine: ${state.vehicle.Engine || 'N/A'} | Transmission: ${state.vehicle.TransmissionStyle || 'N/A'}</p>
      <input placeholder="YouTube API key" value="${state.youtubeKey}" oninput="saveApiKey(this.value)">
      <div class="row">
        <button class="danger" onclick="searchYouTube()">Find YouTube Videos</button>
        <button class="primary" onclick="generatePDF()">Generate Full PDF Printout</button>
      </div>
      <ul>
        <li><a target="_blank" href="https://www.rockauto.com/">Parts Catalog on RockAuto</a></li>
        <li><a target="_blank" href="https://www.autozone.com/repairguides">Repair Guides & Diagrams on AutoZone</a></li>
        <li><a target="_blank" href="https://www.nhtsa.gov/recalls">Official Recalls & TSBs (NHTSA)</a></li>
      </ul>
      <h4>Top YouTube Repair Videos</h4>
      <ul>${state.youtubeVideos.map(v=>`<li><a target="_blank" href="https://youtube.com/watch?v=${v.id.videoId}">${v.snippet.title}</a></li>`).join('')}</ul>` : '<p>No vehicle loaded. Use Lookup tab.</p>';
  }
  if(state.activeTab==='obd'){
    content.innerHTML = `<h3>OBD Helper</h3>
      <div class="row"><input placeholder="P0301 or rough idle" value="${state.obdSearch}" oninput="state.obdSearch=this.value"><button class="primary" onclick="searchOBD()">Search OBD Codes + Symptoms</button></div>
      <ul>${state.obdResults.map(r=>`<li><strong>${r.code}</strong> ‚Äî ${r.description}</li>`).join('')}</ul>`;
  }
  if(state.activeTab==='simulator'){
    const current = circuits[state.selectedCircuit];
    content.innerHTML = `<h3>Electrical Diagnostic Simulator</h3>
      <div class="row">
        <button class="${state.simulatorMode==='guided'?'primary':'inactive'}" onclick="state.simulatorMode='guided';render()">Guided Diagnostic Mode</button>
        <button class="${state.simulatorMode==='advanced'?'primary':'inactive'}" onclick="state.simulatorMode='advanced';render()">Full Advanced Circuit Builder (Falstad)</button>
      </div>
      ${state.simulatorMode==='guided' ? `
        <select onchange="state.selectedCircuit=this.value;state.fault='none';state.measurement={point:'',value:''};render()">${Object.keys(circuits).map(k=>`<option value="${k}" ${k===state.selectedCircuit?'selected':''}>${circuits[k].name}</option>`)}</select>
        <pre>${current.diagram}</pre>
        <div class="row">
          <button class="ok" onclick="injectFault('none')">No Fault</button>
          <button class="danger" onclick="injectFault('open-ground')">Open Ground</button>
          <button class="warn" onclick="injectFault('low-voltage')">Low Charging Voltage</button>
        </div>
        <h4>Virtual Multimeter</h4>
        ${current.probePoints.map(p=>`<button onclick="takeMeasurement('${p}')" style="display:block;width:100%;margin-bottom:8px">Probe: ${p}</button>`).join('')}
        <p><strong>Reading:</strong> ${state.measurement.point ? `${state.measurement.point} ‚Üí ${state.measurement.value}` : 'No measurement yet.'}</p>
        <h4>Simulated Oscilloscope</h4>
        <pre>${state.scopeData} ${state.fault!=='none'?'‚Üê FAULT ACTIVE':''}</pre>
      ` : `
        <p>Full Falstad CircuitJS ‚Äî build any automotive circuit.</p>
        <iframe title="Falstad" src="https://falstad.com/circuit/circuitjs.html" style="width:100%;height:520px;border:1px solid #d1d5db;border-radius:8px"></iframe>
      `}
    `;
  }
}

const tabsEl = document.getElementById('tabs');
const content = document.getElementById('content');
render();
</script>
</body>
</html>
