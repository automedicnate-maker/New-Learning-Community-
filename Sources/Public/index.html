<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FreeAutoDiag Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --red: #e63327;
      --orange: #f5a623;
      --dark: #0a0a0a;
      --panel: #111418;
      --panel2: #181d22;
      --border: #2a2f35;
      --text: #c8cdd3;
      --dim: #5a6270;
      --pass: #27c47a;
      --fail: #e63327;
      --warn: #f5a623;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--dark); color: var(--text); font-family: 'Barlow Condensed', sans-serif; font-size: 15px; }
    .app { min-height: 100vh; display: grid; grid-template-columns: 1fr; }
    .sidebar { border-bottom: 2px solid var(--border); background: var(--panel); padding: 12px; position: sticky; top: 0; z-index: 9; }
    .brand { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .badge { background: var(--red); color: #fff; padding: 5px 10px; font-family: 'Share Tech Mono', monospace; letter-spacing: 1px; font-size: 12px; }
    .subtitle { color: var(--dim); font-family: 'Share Tech Mono', monospace; font-size: 10px; letter-spacing: 1px; }
    .nav { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .nav button { border: 1px solid var(--border); background: var(--panel2); color: var(--text); padding: 10px 6px; font-family: 'Share Tech Mono', monospace; font-size: 11px; letter-spacing: 1px; }
    .nav button.active { border-color: var(--red); color: #fff; background: #250b0a; }

    main { padding: 14px; }
    .view { display: none; animation: fade .2s ease; }
    .view.active { display: block; }
    @keyframes fade { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: translateY(0);} }

    .panel { background: var(--panel2); border: 1px solid var(--border); padding: 12px; margin-bottom: 10px; }
    .title { color: var(--orange); font-family: 'Share Tech Mono', monospace; font-size: 11px; letter-spacing: 2px; margin-bottom: 8px; }
    input, textarea, select { width: 100%; background: #0f1215; color: var(--text); border: 1px solid var(--border); padding: 9px; margin-bottom: 8px; font-family: 'Share Tech Mono', monospace; font-size: 12px; }
    textarea { min-height: 70px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .btn { border: 0; padding: 10px 12px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
    .btn.primary { background: var(--red); color: #fff; }
    .btn.secondary { background: #2a3138; color: var(--text); }
    .btn.warn { background: #3a2a08; color: var(--warn); border: 1px solid #5b4513; }

    .parts-row { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 6px; }
    .part-chip { min-width: 120px; background: #1b2027; border: 1px dashed #4f5760; padding: 10px; text-align: center; cursor: pointer; }
    .tile { border: 1px solid var(--border); background: #0f1215; padding: 10px; margin-bottom: 8px; }
    .tile-head { display:flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .status { font-family: 'Share Tech Mono', monospace; font-size: 11px; padding: 2px 8px; border: 1px solid; }
    .pass { color: var(--pass); border-color: #1f7f52; background: #0b1e16; }
    .fail { color: var(--fail); border-color: #7c201a; background: #220d0c; }
    .pending { color: var(--warn); border-color: #7a5a18; background: #221b0a; }
    .stamp { animation: stamp .3s ease; }
    @keyframes stamp { from { transform: scale(0.5) rotate(-8deg); opacity: 0;} to { transform: scale(1); opacity: 1;} }
    .evidence img { width: 64px; height: 64px; object-fit: cover; border: 1px solid var(--border); margin-right: 6px; }

    .preview-doc { background: #fff; color: #111; padding: 14px; border-radius: 2px; }
    .preview-head { display:flex; justify-content: space-between; border-bottom: 2px solid #ddd; padding-bottom: 8px; margin-bottom: 8px; font-size: 12px; }
    .stamp-badge { border: 3px solid; font-weight: 900; padding: 6px 10px; display: inline-block; transform: rotate(-5deg); margin-bottom: 8px; }
    .stamp-pass { color: #0f7a1c; border-color: #0f7a1c; }
    .stamp-fail { color: #b00020; border-color: #b00020; }
    table { width: 100%; border-collapse: collapse; font-size: 11px; margin: 8px 0; }
    th,td { border: 1px solid #d4d4d4; padding: 5px; vertical-align: top; }

    .rules-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .rule-card { background: var(--panel2); border: 1px solid var(--border); border-left: 3px solid var(--red); padding: 10px; }
    .rule-num { color: var(--dim); font-family: 'Share Tech Mono', monospace; font-size: 10px; }
    .table-wrap { overflow-x: auto; border: 1px solid var(--border); }
    .table-wrap table { min-width: 760px; color: var(--text); }
    .table-wrap th { color: var(--dim); font-family: 'Share Tech Mono', monospace; }

    @media (min-width: 980px) {
      .app { grid-template-columns: 220px 1fr; }
      .sidebar { min-height: 100vh; border-right: 2px solid var(--border); border-bottom: 0; }
      .nav { grid-template-columns: 1fr; }
      main { padding: 18px 20px; max-width: 980px; }
      .row.two { grid-template-columns: 1fr 1fr; }
      .rules-grid { grid-template-columns: 1fr 1fr; }
    }

    @media print {
      body { background: #fff; }
      .sidebar, #builderView, #referenceView { display: none !important; }
      main { padding: 0; }
      .preview-doc { border-radius: 0; }
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div>
        <div class="badge">HWAUT P200</div>
        <div class="subtitle">PROFESSIONAL DIAGNOSTIC FLOW</div>
      </div>
      <strong>FDP</strong>
    </div>
    <div class="nav">
      <button id="nav-builder" class="active" onclick="setView('builder')">01 JOB BUILDER</button>
      <button id="nav-reference" onclick="setView('reference')">02 REFERENCE</button>
      <button id="nav-preview" onclick="setView('preview')">03 REPORT</button>
    </div>
  </aside>

  <main>
    <section id="builderView" class="view active"></section>
    <section id="referenceView" class="view"></section>
    <section id="previewView" class="view"></section>
  </main>
</div>

<script>
const partsCatalog = [
  { key:'battery', icon:'üîã', part:'Battery', test:'Battery OCV', tool:'DVOM', spec:'> 12.6V' },
  { key:'alternator', icon:'‚ö°', part:'Alternator', test:'Charging Voltage', tool:'DVOM', spec:'13.8-14.8V' },
  { key:'starter', icon:'üß≤', part:'Starter', test:'Cranking Drop', tool:'Power Probe', spec:'< 0.5V' },
  { key:'ground', icon:'ü™õ', part:'Ground Strap', test:'Ground Side Drop', tool:'DVOM', spec:'< 0.1V' }
];

const TESTS = [
  { name:'Charging System', tool:'BOTH', p200:'Red clamp ‚Üí B+, Black clamp ‚Üí B‚àí', dvom:'Red ‚Üí B+, Black ‚Üí B‚àí', scenarios:[{scenario:'Alternator healthy at 2k RPM', cond:'Engine 2000 RPM, loads on', result:'pass', value:'14.2V stable'},{scenario:'Regulator overcharge', cond:'Engine running, high output', result:'fail', value:'15.7V over spec'}] },
  { name:'Voltage Drop (Ground)', tool:'DVOM', p200:'N/A', dvom:'Red ‚Üí load ground, Black ‚Üí battery B‚àí', scenarios:[{scenario:'Ground path healthy', cond:'Headlights on', result:'pass', value:'0.03V drop'},{scenario:'Corroded ground strap', cond:'Blower high speed', result:'fail', value:'0.68V drop'}] },
  { name:'Battery Startup', tool:'P200', p200:'Red clamp ‚Üí B+, Black clamp ‚Üí B‚àí', dvom:'Compare crank volts', scenarios:[{scenario:'Battery passes load', cond:'Crank 5 sec', result:'pass', value:'10.0V'},{scenario:'Battery weak', cond:'Cold start', result:'fail', value:'8.2V during crank'}] }
];

const state = {
  activeView: 'builder',
  shop: 'Summit Auto Electrical Diagnostics',
  tech: 'Alex Rivera',
  mileage: '164,288',
  vin: '',
  vehicle: '',
  recommendations: 'Based on current results, repair high resistance grounds and re-test before replacing major components.',
  workOrder: [],
  generated: []
};

function setView(view){
  state.activeView = view;
  ['builder','reference','preview'].forEach(v => {
    document.getElementById(v+'View').classList.toggle('active', v===view);
    document.getElementById('nav-'+v).classList.toggle('active', v===view);
  });
  render();
}

function addPart(key){
  const p = partsCatalog.find(x => x.key===key);
  state.workOrder.push({ id: Date.now()+Math.random(), ...p, measured:'', override:false, overrideSpec:'', notes:'', evidence:[], result:'Pending', stamped:false });
  render();
}

function evaluate(tile){
  const spec = tile.override && tile.overrideSpec ? tile.overrideSpec : tile.spec;
  const val = parseFloat(String(tile.measured).replace(/[^0-9.\-]/g,''));
  if (!tile.measured || Number.isNaN(val)) return 'Pending';
  const gt = spec.match(/>\s*([0-9.]+)/); const lt = spec.match(/<\s*([0-9.]+)/); const range = spec.match(/([0-9.]+)\s*[-‚Äì]\s*([0-9.]+)/);
  if (range) return val >= parseFloat(range[1]) && val <= parseFloat(range[2]) ? 'Pass' : 'Fail';
  if (gt) return val > parseFloat(gt[1]) ? 'Pass' : 'Fail';
  if (lt) return val < parseFloat(lt[1]) ? 'Pass' : 'Fail';
  return 'Pending';
}

function updateTile(id, key, value){
  const t = state.workOrder.find(x => x.id===id); if(!t) return;
  const prev = t.result;
  t[key]=value; t.result = evaluate(t); t.stamped = prev!=='Pass' && t.result==='Pass';
  if (t.stamped) thud();
  render();
}

function thud(){
  try { const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.frequency.value = 125; g.gain.value=.15; g.gain.exponentialRampToValueAtTime(.001, ctx.currentTime+.15); o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+.17);} catch(e){}
}

function uploadEvidence(id, event){
  const tile = state.workOrder.find(t => t.id===id); if(!tile) return;
  [...(event.target.files||[])].forEach(file => {
    const r = new FileReader();
    r.onload = () => { tile.evidence.push({src:r.result, caption:file.name}); render(); };
    r.readAsDataURL(file);
  });
}

function removeTile(id){ state.workOrder = state.workOrder.filter(t=>t.id!==id); render(); }

function badge(){ return state.workOrder.some(t=>t.result==='Fail') ? {text:'ISSUE DETECTED', cls:'stamp-fail'} : {text:'SYSTEM PASS', cls:'stamp-pass'}; }

function generateTests(){
  const num = parseInt(document.getElementById('numTests').value,10);
  const mode = document.getElementById('scenarioType').value;
  const generated = [];
  for (let i=0;i<num;i++){
    const test = TESTS[Math.floor(Math.random()*TESTS.length)];
    let scenarios = test.scenarios;
    if (mode!=='mixed') scenarios = scenarios.filter(s => s.result===mode);
    if (!scenarios.length) continue;
    const s = scenarios[Math.floor(Math.random()*scenarios.length)];
    generated.push({test, s});
  }
  state.generated = generated;
  render();
}

function renderBuilder(){
  document.getElementById('builderView').innerHTML = `
  <div class="panel">
    <div class="title">WORK ORDER HEADER</div>
    <div class="row two">
      <input value="${state.shop}" oninput="state.shop=this.value">
      <input value="${state.tech}" oninput="state.tech=this.value">
    </div>
    <div class="row two">
      <input placeholder="Vehicle (Year Make Model)" value="${state.vehicle}" oninput="state.vehicle=this.value">
      <input placeholder="VIN" value="${state.vin}" oninput="state.vin=this.value">
    </div>
    <input placeholder="Mileage" value="${state.mileage}" oninput="state.mileage=this.value">
  </div>

  <div class="panel">
    <div class="title">PARTS BIN</div>
    <div class="parts-row">${partsCatalog.map(p=>`<div class="part-chip" onclick="addPart('${p.key}')">${p.icon}<div>${p.part}</div></div>`).join('')}</div>
  </div>

  <div class="panel">
    <div class="title">WORK ORDER CANVAS</div>
    ${state.workOrder.map(t=>`<article class="tile">
      <div class="tile-head"><strong>${t.part}</strong><span class="status ${t.result==='Pass'?'pass':t.result==='Fail'?'fail':'pending'} ${t.stamped?'stamp':''}">${t.result}</span></div>
      <input value="${t.test}" oninput="updateTile(${t.id},'test',this.value)">
      <div class="row two"><input value="${t.tool}" oninput="updateTile(${t.id},'tool',this.value)"><input value="${t.spec}" oninput="updateTile(${t.id},'spec',this.value)"></div>
      <input placeholder="Measured" value="${t.measured}" oninput="updateTile(${t.id},'measured',this.value)">
      <label><input type="checkbox" ${t.override?'checked':''} onchange="updateTile(${t.id},'override',this.checked)"> Override manufacturer spec</label>
      ${t.override?`<input placeholder="Override spec" value="${t.overrideSpec}" oninput="updateTile(${t.id},'overrideSpec',this.value)">`:''}
      <textarea placeholder="Finding notes" oninput="updateTile(${t.id},'notes',this.value)">${t.notes}</textarea>
      <div class="row two"><label class="btn warn">üì∑ Add Evidence<input style="display:none" type="file" multiple accept="image/*" onchange="uploadEvidence(${t.id},event)"></label><button class="btn secondary" onclick="removeTile(${t.id})">Remove</button></div>
      <div class="evidence">${t.evidence.map(e=>`<img src="${e.src}" alt="evidence">`).join('')}</div>
    </article>`).join('') || '<p>Tap a part above to start building tests.</p>'}
  </div>

  <button class="btn primary" onclick="setView('preview')">Continue to Report</button>`;
}

function renderReference(){
  document.getElementById('referenceView').innerHTML = `
  <div class="panel"><div class="title">PROBE PLACEMENT RULES</div>
    <div class="rules-grid">
      <div class="rule-card"><div class="rule-num">RULE 01</div><div>Ground lead to solid chassis or battery negative before probing.</div></div>
      <div class="rule-card"><div class="rule-num">RULE 02</div><div>Do not power-output test sensitive drivers before voltage checks.</div></div>
      <div class="rule-card"><div class="rule-num">RULE 03</div><div>Pierce one wire at a time at shallow angle; avoid severing conductor.</div></div>
      <div class="rule-card"><div class="rule-num">RULE 04</div><div>Resistance and diode tests require unpowered, isolated circuits.</div></div>
    </div>
  </div>

  <div class="panel"><div class="title">TEST REFERENCE TABLE</div>
    <div class="table-wrap"><table><thead><tr><th>Test</th><th>Tool</th><th>Condition</th><th>Pass</th><th>Fail</th></tr></thead><tbody>
      <tr><td>Charging System</td><td>BOTH</td><td>2,000 RPM loaded</td><td style="color:var(--pass)">13.5-14.8V</td><td style="color:var(--fail)">&lt;13.5V or &gt;15V</td></tr>
      <tr><td>Ground Voltage Drop</td><td>DVOM</td><td>Circuit under load</td><td style="color:var(--pass)">&lt;0.1V</td><td style="color:var(--fail)">&gt;0.1V</td></tr>
      <tr><td>Battery Startup</td><td>P200</td><td>3-5 sec crank</td><td style="color:var(--pass)">&gt;9.6V</td><td style="color:var(--fail)">&lt;9.6V</td></tr>
    </tbody></table></div>
  </div>

  <div class="panel"><div class="title">RANDOM TEST GENERATOR</div>
    <div class="row two"><select id="numTests"><option>1</option><option selected>3</option><option>5</option></select><select id="scenarioType"><option value="mixed" selected>Mixed</option><option value="pass">Pass Only</option><option value="fail">Fail Only</option></select></div>
    <button class="btn primary" onclick="generateTests()">Generate Tests</button>
    <div>${state.generated.map((g,i)=>`<article class="tile"><div class="title">#${i+1} ${g.test.name}</div><div>${g.s.scenario}</div><div class="subtitle">${g.s.cond}</div><div class="status ${g.s.result==='pass'?'pass':'fail'}">${g.s.result.toUpperCase()} ¬∑ ${g.s.value}</div></article>`).join('')}</div>
  </div>`;
}

function renderPreview(){
  const b = badge();
  const evidence = state.workOrder.flatMap(t => t.evidence.map(e => ({src:e.src, cap:t.notes || t.test})));
  document.getElementById('previewView').innerHTML = `
  <div class="panel">
    <button class="btn primary" onclick="window.print()">Generate Report / Print</button>
  </div>
  <article class="preview-doc">
    <div class="preview-head"><div><strong>${state.shop}</strong><div>Technician: ${state.tech}</div></div><div><div>${state.vehicle || 'Vehicle N/A'}</div><div>VIN: ${state.vin || 'N/A'}</div><div>Mileage: ${state.mileage}</div></div></div>
    <div class="stamp-badge ${b.cls}">[${b.text}]</div>
    <h3>Diagnostic Checklist</h3>
    <table><thead><tr><th>Test Performed</th><th>Tool</th><th>Spec/Limit</th><th>Measured</th><th>Result</th></tr></thead><tbody>
      ${state.workOrder.map(t=>`<tr><td>${t.test}</td><td>${t.tool}</td><td>${t.override&&t.overrideSpec?t.overrideSpec:t.spec}</td><td>${t.measured||'‚Äî'}</td><td>${t.result==='Pass'?'‚úÖ PASS':t.result==='Fail'?'‚ùå FAIL':'‚ö†Ô∏è PENDING'}</td></tr>`).join('') || '<tr><td colspan="5">No tests added.</td></tr>'}
    </tbody></table>
    <h3>Evidence</h3>
    <div class="row two">${evidence.map(e=>`<figure><img src="${e.src}" style="width:100%;height:110px;object-fit:cover;border:1px solid #d8d8d8"><figcaption style="font-size:11px">${e.cap}</figcaption></figure>`).join('') || 'No evidence uploaded.'}</div>
    <h3>Recommendations</h3><p>${state.recommendations}</p>
  </article>`;
}

function render(){ renderBuilder(); renderReference(); renderPreview(); }
render();
</script>
</body>
</html>
